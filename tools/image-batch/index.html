<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Batch Processor - ClaudeTools</title>
  <meta name="description" content="Batch resize, rename, and export images to a uniform size and format for game assets.">
  <link rel="stylesheet" href="../../css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* ===== Tool-specific styles ===== */
    .app-container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 1.5rem 2rem 4rem;
      width: 100%;
    }

    .app-container h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .app-container .subtitle {
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 1.5rem;
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .drop-zone h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .drop-zone p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .drop-zone input[type="file"] {
      display: none;
    }

    /* Panels */
    .panels {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 1.5rem;
      align-items: start;
    }

    @media (max-width: 800px) {
      .panels {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
    }

    .panel h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    /* Image list */
    .image-list {
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .image-list::-webkit-scrollbar {
      width: 6px;
    }

    .image-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .image-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      border: 1px solid transparent;
    }

    .image-item:hover {
      border-color: var(--border);
    }

    .image-thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      background: var(--bg-primary);
      flex-shrink: 0;
    }

    .image-info {
      flex-grow: 1;
      min-width: 0;
    }

    .image-name {
      font-size: 0.82rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .image-dims {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .image-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0.25rem;
      line-height: 1;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .image-remove:hover {
      color: #f85149;
      background: rgba(248, 81, 73, 0.1);
    }

    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .list-header h2 {
      border: none;
      padding: 0;
      margin: 0;
    }

    .clear-all {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: none;
      border: 1px solid var(--border);
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .clear-all:hover {
      color: #f85149;
      border-color: #f85149;
    }

    /* Settings controls */
    .control-group {
      margin-bottom: 1.25rem;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.4rem;
      color: var(--text-secondary);
    }

    .control-group input[type="number"],
    .control-group input[type="text"],
    .control-group select {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: inherit;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .size-inputs {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .size-inputs input {
      flex: 1;
    }

    .size-inputs .x-label {
      color: var(--text-muted);
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .detected-size {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
    }

    .detected-size button {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 0.78rem;
      padding: 0;
      text-decoration: underline;
    }

    .detected-size button:hover {
      color: var(--accent-hover);
    }

    .quality-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .quality-row input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
    }

    .quality-val {
      font-size: 0.85rem;
      color: var(--text-secondary);
      min-width: 2.5rem;
      text-align: right;
    }

    /* Fit mode */
    .fit-options {
      display: flex;
      gap: 0.5rem;
    }

    .fit-option {
      flex: 1;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      font-size: 0.82rem;
      color: var(--text-secondary);
      transition: border-color 0.2s, color 0.2s;
    }

    .fit-option:hover {
      border-color: var(--text-muted);
    }

    .fit-option.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-subtle);
    }

    .fit-option-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.15rem;
      font-size: 0.85rem;
    }

    .bg-color-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .bg-color-row input[type="color"] {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: none;
      cursor: pointer;
      padding: 0;
    }

    .bg-color-row span {
      font-size: 0.82rem;
      color: var(--text-secondary);
    }

    /* Mode toggle */
    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }

    .mode-option {
      flex: 1;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      font-size: 0.82rem;
      color: var(--text-secondary);
      transition: border-color 0.2s, color 0.2s;
    }

    .mode-option:hover {
      border-color: var(--text-muted);
    }

    .mode-option.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-subtle);
    }

    .mode-option-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.15rem;
      font-size: 0.85rem;
    }

    .settings-dimmed {
      opacity: 0.35;
      pointer-events: none;
    }

    /* Summary bar */
    .summary-bar {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .summary-stat {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .summary-stat strong {
      color: var(--text-primary);
    }

    /* ===== Rename Panel (full width below) ===== */
    .rename-panel {
      margin-top: 1.5rem;
    }

    .rename-panel h2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .rename-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .rename-toolbar .toolbar-group {
      display: flex;
      gap: 0.35rem;
      align-items: center;
    }

    .rename-toolbar .toolbar-separator {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 0.25rem;
    }

    .toolbar-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.35rem 0.7rem;
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      transition: border-color 0.2s, color 0.2s;
    }

    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .toolbar-btn.accent {
      background: var(--accent-subtle);
      border-color: var(--accent);
      color: var(--accent);
    }

    .toolbar-btn.accent:hover {
      background: var(--accent);
      color: #fff;
    }

    .toolbar-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .toolbar-btn:disabled:hover {
      border-color: var(--border);
      color: var(--text-secondary);
    }

    .toolbar-input {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.35rem 0.6rem;
      color: var(--text-primary);
      font-size: 0.8rem;
      width: 120px;
      font-family: inherit;
    }

    .toolbar-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .toolbar-input::placeholder {
      color: var(--text-muted);
    }

    .detected-prefix {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-family: monospace;
    }

    .detected-prefix code {
      background: var(--bg-primary);
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--orange);
    }

    /* Rename table */
    .rename-table {
      max-height: 520px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .rename-table::-webkit-scrollbar {
      width: 6px;
    }

    .rename-table::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .rename-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.4rem 0.5rem;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid transparent;
    }

    .rename-row:hover {
      border-color: var(--border);
    }

    .rename-row .rn-thumb {
      width: 36px;
      height: 36px;
      object-fit: cover;
      border-radius: 4px;
      background: var(--bg-primary);
      flex-shrink: 0;
    }

    .rename-row .rn-index {
      font-size: 0.75rem;
      color: var(--text-muted);
      min-width: 1.8rem;
      text-align: right;
      flex-shrink: 0;
    }

    .rename-row .rn-original {
      font-size: 0.75rem;
      color: var(--text-muted);
      min-width: 0;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: monospace;
    }

    .rename-row .rn-arrow {
      color: var(--text-muted);
      flex-shrink: 0;
      font-size: 0.85rem;
    }

    .rename-row .rn-input {
      flex: 1.5;
      min-width: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.3rem 0.5rem;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
    }

    .rename-row .rn-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .rename-row .rn-ext {
      font-size: 0.8rem;
      color: var(--text-muted);
      flex-shrink: 0;
      font-family: monospace;
    }

    /* Process button */
    .process-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 1.25rem;
    }

    .process-btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .process-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Progress */
    .progress-bar-container {
      margin-top: 1rem;
      display: none;
    }

    .progress-bar-container.visible {
      display: block;
    }

    .progress-bar-outer {
      background: var(--bg-primary);
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress-bar-inner {
      height: 100%;
      background: var(--accent);
      border-radius: 999px;
      transition: width 0.15s;
      width: 0%;
    }

    .progress-text {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .rename-row .rn-original {
        display: none;
      }
    }
  </style>
</head>
<body>

  <header class="site-header">
    <div class="header-inner">
      <a href="../../" class="site-logo">
        <span class="logo-icon">&#9881;</span>
        ClaudeTools
      </a>
      <nav>
        <ul class="nav-links">
          <li><a href="../../#tools">Tools</a></li>
          <li><a href="https://github.com/imakefun/ClaudeTools">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="app-container">
    <h1>Image Batch Processor</h1>
    <p class="subtitle">Resize, rename, and export up to 200 images to a uniform size and format.</p>

    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
      <h3>Drop images here or click to browse</h3>
      <p>Supports PNG, JPG, JPEG, WEBP, BMP, GIF, SVG &mdash; up to 200 images</p>
      <input type="file" id="fileInput" multiple accept="image/*">
    </div>

    <!-- Main content (hidden until images are added) -->
    <div class="hidden" id="mainContent">

      <!-- Top row: image list + output settings -->
      <div class="panels">

        <!-- Left: Image list -->
        <div class="panel">
          <div class="list-header">
            <h2>Images <span id="imageCountLabel">(0)</span></h2>
            <button class="clear-all" id="clearAllBtn">Clear all</button>
          </div>

          <div class="summary-bar" id="summaryBar">
            <span class="summary-stat">Widths: <strong id="statWidths">-</strong></span>
            <span class="summary-stat">Heights: <strong id="statHeights">-</strong></span>
            <span class="summary-stat">Formats: <strong id="statFormats">-</strong></span>
          </div>

          <div class="image-list" id="imageList"></div>
        </div>

        <!-- Right: Settings -->
        <div class="panel">
          <h2>Output Settings</h2>

          <div class="mode-toggle">
            <div class="mode-option active" data-mode="full" id="modeFullBtn">
              <span class="mode-option-label">Full Process</span>
              Resize, convert &amp; rename
            </div>
            <div class="mode-option" data-mode="rename" id="modeRenameBtn">
              <span class="mode-option-label">Rename Only</span>
              Keep original files
            </div>
          </div>

          <div id="resizeFormatControls">
          <div class="control-group">
            <label>Target Size (px)</label>
            <div class="size-inputs">
              <input type="number" id="targetWidth" min="1" max="8192" placeholder="Width">
              <span class="x-label">&times;</span>
              <input type="number" id="targetHeight" min="1" max="8192" placeholder="Height">
            </div>
            <div class="detected-size" id="detectedSize"></div>
          </div>

          <div class="control-group">
            <label>Fit Mode</label>
            <div class="fit-options">
              <div class="fit-option active" data-mode="cover">
                <span class="fit-option-label">Cover</span>
                Fill &amp; crop
              </div>
              <div class="fit-option" data-mode="contain">
                <span class="fit-option-label">Contain</span>
                Fit &amp; pad
              </div>
            </div>
            <div class="bg-color-row hidden" id="bgColorRow">
              <input type="color" id="bgColor" value="#000000">
              <span>Background fill color</span>
            </div>
          </div>

          <div class="control-group">
            <label>Export Format</label>
            <select id="exportFormat">
              <option value="image/png">PNG</option>
              <option value="image/jpeg">JPG</option>
              <option value="image/webp">WEBP</option>
            </select>
          </div>

          <div class="control-group" id="qualityGroup">
            <label>Quality</label>
            <div class="quality-row">
              <input type="range" id="qualitySlider" min="10" max="100" value="92">
              <span class="quality-val" id="qualityVal">92%</span>
            </div>
          </div>
          </div><!-- /resizeFormatControls -->
        </div>
      </div>

      <!-- Full-width rename panel -->
      <div class="panel rename-panel">
        <h2>
          Rename
          <span style="font-size:0.78rem; font-weight:400; color:var(--text-muted)">Edit export names individually or use the tools below</span>
        </h2>

        <!-- Toolbar -->
        <div class="rename-toolbar">
          <div class="toolbar-group">
            <button class="toolbar-btn accent" id="btnSmartSimplify" title="Auto-strip common prefix, trailing numbers, and extract the subject name">Smart Simplify</button>
          </div>

          <div class="toolbar-separator"></div>

          <div class="toolbar-group">
            <button class="toolbar-btn" id="btnStripPrefix" title="Remove the shared prefix from all names">Strip Prefix</button>
            <button class="toolbar-btn" id="btnStripSuffix" title="Remove the shared suffix from all names">Strip Suffix</button>
            <button class="toolbar-btn" id="btnStripTrailingNums" title="Remove trailing _number patterns">Strip Trailing #</button>
          </div>

          <div class="toolbar-separator"></div>

          <div class="toolbar-group">
            <input type="text" class="toolbar-input" id="findInput" placeholder="Find...">
            <input type="text" class="toolbar-input" id="replaceInput" placeholder="Replace with...">
            <button class="toolbar-btn" id="btnFindReplace">Replace</button>
          </div>

          <div class="toolbar-separator"></div>

          <div class="toolbar-group">
            <input type="text" class="toolbar-input" id="removeAfterInput" placeholder="e.g. ___" style="width:80px">
            <button class="toolbar-btn" id="btnRemoveAfter" title="Remove everything after (and including) the given string">Remove After</button>
          </div>

          <div class="toolbar-separator"></div>

          <div class="toolbar-group">
            <input type="text" class="toolbar-input" id="patternInput" placeholder="Pattern prefix..." style="width:100px">
            <button class="toolbar-btn" id="btnApplyPattern" title="Set all names to prefix_001, prefix_002, ...">Apply Pattern</button>
          </div>

          <div class="toolbar-separator"></div>

          <div class="toolbar-group">
            <button class="toolbar-btn" id="btnResetNames" title="Reset all names back to originals">Reset</button>
          </div>
        </div>

        <div class="detected-prefix" id="detectedPrefixInfo"></div>

        <!-- Rename table -->
        <div class="rename-table" id="renameTable"></div>
      </div>

      <!-- Process button -->
      <button class="process-btn" id="processBtn" disabled style="margin-top:1.5rem">Process &amp; Download ZIP</button>

      <div class="progress-bar-container" id="progressContainer">
        <div class="progress-bar-outer">
          <div class="progress-bar-inner" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">0 / 0</div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <p>ClaudeTools &mdash; built one tool at a time.</p>
  </footer>

  <script>
    (() => {
      "use strict";

      const MAX_IMAGES = 200;

      // State
      let images = [];      // { file, name, width, height, objectUrl, exportName }
      let fitMode = "cover";
      let renameOnlyMode = false;

      // DOM refs
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const mainContent = document.getElementById("mainContent");
      const imageList = document.getElementById("imageList");
      const imageCountLabel = document.getElementById("imageCountLabel");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const targetWidth = document.getElementById("targetWidth");
      const targetHeight = document.getElementById("targetHeight");
      const detectedSize = document.getElementById("detectedSize");
      const exportFormat = document.getElementById("exportFormat");
      const qualityGroup = document.getElementById("qualityGroup");
      const qualitySlider = document.getElementById("qualitySlider");
      const qualityVal = document.getElementById("qualityVal");
      const processBtn = document.getElementById("processBtn");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const bgColorRow = document.getElementById("bgColorRow");
      const bgColor = document.getElementById("bgColor");
      const statWidths = document.getElementById("statWidths");
      const statHeights = document.getElementById("statHeights");
      const statFormats = document.getElementById("statFormats");
      const fitOptions = document.querySelectorAll(".fit-option");
      const renameTable = document.getElementById("renameTable");
      const detectedPrefixInfo = document.getElementById("detectedPrefixInfo");
      const modeFullBtn = document.getElementById("modeFullBtn");
      const modeRenameBtn = document.getElementById("modeRenameBtn");
      const resizeFormatControls = document.getElementById("resizeFormatControls");

      // Rename toolbar
      const btnSmartSimplify = document.getElementById("btnSmartSimplify");
      const btnStripPrefix = document.getElementById("btnStripPrefix");
      const btnStripSuffix = document.getElementById("btnStripSuffix");
      const btnStripTrailingNums = document.getElementById("btnStripTrailingNums");
      const findInput = document.getElementById("findInput");
      const replaceInput = document.getElementById("replaceInput");
      const btnFindReplace = document.getElementById("btnFindReplace");
      const removeAfterInput = document.getElementById("removeAfterInput");
      const btnRemoveAfter = document.getElementById("btnRemoveAfter");
      const patternInput = document.getElementById("patternInput");
      const btnApplyPattern = document.getElementById("btnApplyPattern");
      const btnResetNames = document.getElementById("btnResetNames");

      // ===== Helpers =====

      function baseName(filename) {
        return filename.replace(/\.[^.]+$/, "");
      }

      function formatToExt(mime) {
        if (mime === "image/png") return ".png";
        if (mime === "image/jpeg") return ".jpg";
        if (mime === "image/webp") return ".webp";
        return ".png";
      }

      function currentExt() {
        return formatToExt(exportFormat.value);
      }

      // ===== File Handling =====

      dropZone.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", (e) => addFiles(e.target.files));

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
      });
      dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag-over"));
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        addFiles(e.dataTransfer.files);
      });

      async function addFiles(fileList) {
        const files = Array.from(fileList).filter((f) => f.type.startsWith("image/"));
        const space = MAX_IMAGES - images.length;
        const toAdd = files.slice(0, space);

        if (files.length > space) {
          alert(`Only ${space} more image(s) can be added (max ${MAX_IMAGES}).`);
        }

        const promises = toAdd.map((file) => loadImage(file));
        const loaded = await Promise.all(promises);
        images.push(...loaded.filter(Boolean));
        refresh();
      }

      function loadImage(file) {
        return new Promise((resolve) => {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => {
            const base = baseName(file.name);
            resolve({
              file,
              name: file.name,
              width: img.naturalWidth,
              height: img.naturalHeight,
              objectUrl: url,
              exportName: base,
            });
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            resolve(null);
          };
          img.src = url;
        });
      }

      // ===== UI Refresh =====

      function refresh() {
        mainContent.classList.toggle("hidden", images.length === 0);
        imageCountLabel.textContent = `(${images.length})`;
        processBtn.disabled = images.length === 0;
        renderImageList();
        renderRenameTable();
        computeStats();
        computeOptimalSize();
        updateDetectedPrefix();
      }

      function renderImageList() {
        imageList.innerHTML = "";
        images.forEach((img, i) => {
          const el = document.createElement("div");
          el.className = "image-item";
          el.innerHTML = `
            <img class="image-thumb" src="${img.objectUrl}" alt="">
            <div class="image-info">
              <div class="image-name" title="${img.name}">${img.name}</div>
              <div class="image-dims">${img.width} &times; ${img.height}</div>
            </div>
            <button class="image-remove" title="Remove">&times;</button>
          `;
          el.querySelector(".image-remove").addEventListener("click", () => {
            URL.revokeObjectURL(images[i].objectUrl);
            images.splice(i, 1);
            refresh();
          });
          imageList.appendChild(el);
        });
      }

      function originalExt(filename) {
        const m = filename.match(/\.[^.]+$/);
        return m ? m[0] : "";
      }

      function renderRenameTable() {
        renameTable.innerHTML = "";
        images.forEach((img, i) => {
          const ext = renameOnlyMode ? originalExt(img.name) : currentExt();
          const row = document.createElement("div");
          row.className = "rename-row";
          row.innerHTML = `
            <span class="rn-index">${i + 1}</span>
            <img class="rn-thumb" src="${img.objectUrl}" alt="">
            <span class="rn-original" title="${img.name}">${img.name}</span>
            <span class="rn-arrow">&rarr;</span>
            <input class="rn-input" type="text" value="${img.exportName}" data-idx="${i}">
            <span class="rn-ext">${ext}</span>
          `;
          const input = row.querySelector(".rn-input");
          input.addEventListener("input", () => {
            images[i].exportName = input.value;
          });
          renameTable.appendChild(row);
        });
      }

      // Update .rn-ext when format changes
      exportFormat.addEventListener("change", () => {
        const ext = currentExt();
        renameTable.querySelectorAll(".rn-ext").forEach((el) => {
          el.textContent = ext;
        });
        qualityGroup.style.display = exportFormat.value === "image/png" ? "none" : "";
      });
      qualityGroup.style.display = exportFormat.value === "image/png" ? "none" : "";

      function computeStats() {
        if (images.length === 0) return;
        const widths = [...new Set(images.map((i) => i.width))].sort((a, b) => a - b);
        const heights = [...new Set(images.map((i) => i.height))].sort((a, b) => a - b);
        const formats = [...new Set(images.map((i) => {
          const ext = i.name.split(".").pop().toLowerCase();
          return ext;
        }))].sort();

        statWidths.textContent = widths.length <= 3
          ? widths.join(", ") + "px"
          : `${widths[0]}\u2013${widths[widths.length - 1]}px (${widths.length} unique)`;
        statHeights.textContent = heights.length <= 3
          ? heights.join(", ") + "px"
          : `${heights[0]}\u2013${heights[heights.length - 1]}px (${heights.length} unique)`;
        statFormats.textContent = formats.join(", ").toUpperCase();
      }

      function computeOptimalSize() {
        if (images.length === 0) return;
        const minW = Math.min(...images.map((i) => i.width));
        const minH = Math.min(...images.map((i) => i.height));

        if (!targetWidth.dataset.userSet) targetWidth.value = minW;
        if (!targetHeight.dataset.userSet) targetHeight.value = minH;

        detectedSize.innerHTML = `Suggested: ${minW} &times; ${minH} (no upscaling) &mdash; <button id="applySuggested">apply</button>`;
        document.getElementById("applySuggested").addEventListener("click", () => {
          targetWidth.value = minW;
          targetHeight.value = minH;
          delete targetWidth.dataset.userSet;
          delete targetHeight.dataset.userSet;
        });
      }

      targetWidth.addEventListener("input", () => { targetWidth.dataset.userSet = "1"; });
      targetHeight.addEventListener("input", () => { targetHeight.dataset.userSet = "1"; });

      // ===== Fit Mode =====

      fitOptions.forEach((opt) => {
        opt.addEventListener("click", () => {
          fitOptions.forEach((o) => o.classList.remove("active"));
          opt.classList.add("active");
          fitMode = opt.dataset.mode;
          bgColorRow.classList.toggle("hidden", fitMode !== "contain");
        });
      });

      qualitySlider.addEventListener("input", () => {
        qualityVal.textContent = qualitySlider.value + "%";
      });

      // ===== Mode Toggle =====

      modeFullBtn.addEventListener("click", () => {
        renameOnlyMode = false;
        modeFullBtn.classList.add("active");
        modeRenameBtn.classList.remove("active");
        resizeFormatControls.classList.remove("settings-dimmed");
        renderRenameTable();
      });

      modeRenameBtn.addEventListener("click", () => {
        renameOnlyMode = true;
        modeRenameBtn.classList.add("active");
        modeFullBtn.classList.remove("active");
        resizeFormatControls.classList.add("settings-dimmed");
        renderRenameTable();
      });

      // ===== Rename Logic =====

      // Longest common prefix of an array of strings (word-boundary aware using separator)
      function longestCommonPrefix(strings, sep) {
        if (strings.length === 0) return "";
        let prefix = strings[0];
        for (let i = 1; i < strings.length; i++) {
          while (strings[i].indexOf(prefix) !== 0) {
            prefix = prefix.substring(0, prefix.length - 1);
            if (prefix === "") return "";
          }
        }
        // Snap to the last separator boundary so we don't cut mid-word
        if (sep) {
          const lastSep = prefix.lastIndexOf(sep);
          if (lastSep > 0 && lastSep < prefix.length - 1) {
            prefix = prefix.substring(0, lastSep + 1);
          }
        }
        return prefix;
      }

      // Longest common suffix (word-boundary aware)
      function longestCommonSuffix(strings, sep) {
        const reversed = strings.map((s) => s.split("").reverse().join(""));
        const revPrefix = longestCommonPrefix(reversed, sep);
        const suffix = revPrefix.split("").reverse().join("");
        if (sep) {
          const firstSep = suffix.indexOf(sep);
          if (firstSep > 0 && firstSep < suffix.length - 1) {
            return suffix.substring(firstSep);
          }
        }
        return suffix;
      }

      function getExportNames() {
        return images.map((img) => img.exportName);
      }

      function setExportNames(names) {
        names.forEach((n, i) => {
          if (i < images.length) images[i].exportName = n;
        });
        syncRenameInputs();
      }

      function syncRenameInputs() {
        const inputs = renameTable.querySelectorAll(".rn-input");
        inputs.forEach((input, i) => {
          if (i < images.length) input.value = images[i].exportName;
        });
      }

      function updateDetectedPrefix() {
        if (images.length < 2) {
          detectedPrefixInfo.innerHTML = "";
          return;
        }
        const names = getExportNames();
        const prefix = longestCommonPrefix(names, "_");
        if (prefix.length > 0) {
          detectedPrefixInfo.innerHTML = `Detected shared prefix: <code>${prefix}</code>`;
        } else {
          detectedPrefixInfo.innerHTML = "";
        }
      }

      // --- Strip Common Prefix ---
      btnStripPrefix.addEventListener("click", () => {
        const names = getExportNames();
        if (names.length < 2) return;
        const prefix = longestCommonPrefix(names, "_");
        if (!prefix) return;
        setExportNames(names.map((n) => n.startsWith(prefix) ? n.slice(prefix.length) || n : n));
        updateDetectedPrefix();
      });

      // --- Strip Common Suffix ---
      btnStripSuffix.addEventListener("click", () => {
        const names = getExportNames();
        if (names.length < 2) return;
        const suffix = longestCommonSuffix(names, "_");
        if (!suffix) return;
        setExportNames(names.map((n) => n.endsWith(suffix) ? n.slice(0, -suffix.length) || n : n));
        updateDetectedPrefix();
      });

      // --- Strip Trailing Numbers ---
      btnStripTrailingNums.addEventListener("click", () => {
        const names = getExportNames();
        setExportNames(names.map((n) => n.replace(/[_\-\s]*\d+$/, "") || n));
        updateDetectedPrefix();
      });

      // --- Find & Replace ---
      btnFindReplace.addEventListener("click", () => {
        const find = findInput.value;
        if (!find) return;
        const replace = replaceInput.value;
        const names = getExportNames();
        setExportNames(names.map((n) => n.split(find).join(replace)));
        updateDetectedPrefix();
      });

      // --- Remove After ---
      btnRemoveAfter.addEventListener("click", () => {
        const marker = removeAfterInput.value;
        if (!marker) return;
        const names = getExportNames();
        setExportNames(names.map((n) => {
          const idx = n.indexOf(marker);
          return idx !== -1 ? (n.slice(0, idx) || n) : n;
        }));
        updateDetectedPrefix();
      });

      // --- Apply Pattern ---
      btnApplyPattern.addEventListener("click", () => {
        const prefix = patternInput.value.trim();
        if (!prefix) return;
        const pad = String(images.length).length;
        setExportNames(images.map((_, i) => prefix + "_" + String(i + 1).padStart(pad, "0")));
        updateDetectedPrefix();
      });

      // --- Reset Names ---
      btnResetNames.addEventListener("click", () => {
        images.forEach((img) => {
          img.exportName = baseName(img.name);
        });
        syncRenameInputs();
        updateDetectedPrefix();
      });

      // --- Smart Simplify ---
      btnSmartSimplify.addEventListener("click", () => {
        if (images.length === 0) return;

        // Step 1: Start from original base names
        let names = images.map((img) => baseName(img.name));

        // Step 2: Strip common prefix (at word boundary)
        if (names.length >= 2) {
          const prefix = longestCommonPrefix(names, "_");
          if (prefix) {
            names = names.map((n) => n.startsWith(prefix) ? n.slice(prefix.length) || n : n);
          }
        }

        // Step 3: Strip trailing number pattern
        names = names.map((n) => n.replace(/[_\-\s]*\d+$/, "") || n);

        // Step 4: Extract the subject/title from the remaining text
        // Heuristic: walk underscore-separated tokens from the start.
        // Keep tokens while they start with an uppercase letter (title words).
        // Stop when we hit a fully-lowercase token (likely a descriptor).
        names = names.map((n) => extractTitle(n));

        setExportNames(names);
        updateDetectedPrefix();
      });

      function extractTitle(name) {
        const tokens = name.split("_");
        const titleTokens = [];

        for (const token of tokens) {
          if (!token) continue;
          // If starts with uppercase -> likely a title word
          if (token[0] === token[0].toUpperCase() && token[0] !== token[0].toLowerCase()) {
            titleTokens.push(token);
          } else {
            // Lowercase token -> we've passed the title
            break;
          }
        }

        if (titleTokens.length === 0) {
          // No uppercase tokens found; fall back to first 2-3 tokens
          return tokens.slice(0, Math.min(3, tokens.length)).join("_");
        }

        // Clean the last title token: it might have lowercase chars run-on
        // e.g., "Accurseda" should become "Accursed"
        // Heuristic: if the last token ends with a single lowercase letter
        // that looks like a conjunction/article appended (a, e, i, o, the, an),
        // trim it. More aggressively: trim trailing lowercase segment if it
        // makes the token look like it ends cleanly.
        const lastIdx = titleTokens.length - 1;
        titleTokens[lastIdx] = cleanTrailingRunon(titleTokens[lastIdx]);

        return titleTokens.join("_");
      }

      function cleanTrailingRunon(word) {
        // If word is short, don't trim
        if (word.length <= 3) return word;

        // Find where the trailing lowercase segment starts after the initial
        // uppercase portion. E.g., "Accurseda" -> "Accursed" + "a"
        // Walk backwards while chars are lowercase
        let cutPoint = word.length;
        while (cutPoint > 1 && word[cutPoint - 1] === word[cutPoint - 1].toLowerCase() &&
               word[cutPoint - 1] !== word[cutPoint - 1].toUpperCase()) {
          cutPoint--;
        }

        // cutPoint is now at the last uppercase or start.
        // The "clean" part is everything up to some point after cutPoint.
        // We want to detect if there's a small trailing lowercase fragment.

        // Actually let's try a different approach:
        // Common suffixes from AI generators that get appended: a, an, the, in, of, with
        // Check if the word ends with a common short word run-on
        const runons = ["athe", "aand", "ain", "awith", "aof", "ais", "afor",
                        "alarge", "adark", "asmall", "agod", "astone", "aancient",
                        "aepic", "amyst"];
        const lower = word.toLowerCase();
        for (const suffix of runons) {
          if (lower.endsWith(suffix) && word.length > suffix.length + 2) {
            return word.slice(0, word.length - suffix.length);
          }
        }

        // Simpler: if the word ends with a single 'a','e','i','o' that seems
        // tacked on (the char before it is a consonant and lowercase),
        // and removing it leaves a word > 4 chars, trim it.
        const lastChar = word[word.length - 1].toLowerCase();
        if ("aeiou".includes(lastChar) && word.length > 5) {
          const beforeLast = word[word.length - 2].toLowerCase();
          if (!"aeiou".includes(beforeLast)) {
            // Looks like a trailing vowel tacked on (e.g., "Accurseda" -> "Accursed")
            return word.slice(0, -1);
          }
        }

        return word;
      }

      // ===== Clear All =====

      clearAllBtn.addEventListener("click", () => {
        images.forEach((i) => URL.revokeObjectURL(i.objectUrl));
        images = [];
        delete targetWidth.dataset.userSet;
        delete targetHeight.dataset.userSet;
        refresh();
      });

      // ===== Process =====

      processBtn.addEventListener("click", processImages);

      async function processImages() {
        if (!renameOnlyMode) {
          const w = parseInt(targetWidth.value, 10);
          const h = parseInt(targetHeight.value, 10);
          if (!w || !h || w < 1 || h < 1) {
            alert("Please enter a valid target width and height.");
            return;
          }
        }

        processBtn.disabled = true;
        progressContainer.classList.add("visible");

        const zip = new JSZip();
        const usedNames = new Set();

        if (renameOnlyMode) {
          // Rename only: zip original files with new names
          for (let i = 0; i < images.length; i++) {
            progressBar.style.width = ((i / images.length) * 100) + "%";
            progressText.textContent = `${i} / ${images.length}`;

            const ext = originalExt(images[i].name);
            let filename = (images[i].exportName || "image_" + (i + 1)) + ext;

            let base = filename;
            let counter = 2;
            while (usedNames.has(filename.toLowerCase())) {
              const dot = base.lastIndexOf(".");
              filename = base.slice(0, dot) + "_" + counter + base.slice(dot);
              counter++;
            }
            usedNames.add(filename.toLowerCase());

            zip.file(filename, images[i].file);
          }
        } else {
          // Full process: resize, convert, rename
          const w = parseInt(targetWidth.value, 10);
          const h = parseInt(targetHeight.value, 10);
          const fmt = exportFormat.value;
          const quality = fmt === "image/png" ? undefined : parseInt(qualitySlider.value, 10) / 100;
          const ext = currentExt();
          const bg = bgColor.value;

          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");

          for (let i = 0; i < images.length; i++) {
            progressBar.style.width = ((i / images.length) * 100) + "%";
            progressText.textContent = `${i} / ${images.length}`;

            const img = await createImageBitmap(images[i].file);

            ctx.clearRect(0, 0, w, h);

            if (fitMode === "contain") {
              ctx.fillStyle = bg;
              ctx.fillRect(0, 0, w, h);
              const scale = Math.min(w / img.width, h / img.height);
              const sw = img.width * scale;
              const sh = img.height * scale;
              ctx.drawImage(img, (w - sw) / 2, (h - sh) / 2, sw, sh);
            } else {
              const scale = Math.max(w / img.width, h / img.height);
              const sw = img.width * scale;
              const sh = img.height * scale;
              ctx.drawImage(img, (w - sw) / 2, (h - sh) / 2, sw, sh);
            }

            img.close();

            const blob = await new Promise((resolve) => canvas.toBlob(resolve, fmt, quality));

            let filename = (images[i].exportName || "image_" + (i + 1)) + ext;

            let base = filename;
            let counter = 2;
            while (usedNames.has(filename.toLowerCase())) {
              const dot = base.lastIndexOf(".");
              filename = base.slice(0, dot) + "_" + counter + base.slice(dot);
              counter++;
            }
            usedNames.add(filename.toLowerCase());

            zip.file(filename, blob);
          }
        }

        progressBar.style.width = "100%";
        progressText.textContent = `${images.length} / ${images.length} \u2014 zipping...`;

        const zipBlob = await zip.generateAsync({ type: "blob" });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(zipBlob);
        a.download = "images_batch.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);

        progressText.textContent = "Done!";
        processBtn.disabled = false;

        setTimeout(() => {
          progressContainer.classList.remove("visible");
          progressBar.style.width = "0%";
        }, 3000);
      }

      // ===== Init =====
      refresh();
    })();
  </script>

</body>
</html>
